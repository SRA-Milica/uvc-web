import{d as Ne,f as De,S as Te,c as N,L as qe,E as h,M as te,N as se,O as oe,j as Re,aa as ne,a as v,b as e,t as r,u as D,F as V,r as le,n as C,l as Ce,P as Me,w as ae,v as ie,s as M,H as je,R as Ae,ab as Ve,Z as $e,ac as Ee,Y as Pe,$ as ue,a2 as j,a0 as Ue,o as m,a1 as $,ad as Be,a4 as E}from"./index-75810c09.js";const Fe={class:"py-10"},Le={key:0},Oe={class:"mb-16"},ze={class:"font-bold text-center"},Qe={class:"mb-16 w-[80%] mx-auto"},He=e("h2",{class:"text-2xl font-bold text-primary"},"Survey Details",-1),Ie={class:"tableView table mb-5"},Ke=e("th",null,"Description",-1),Ye={class:"scrollable-content"},Ze=e("th",null,"Sender",-1),Ge=e("th",null,"Publication Period",-1),Je=e("th",null,"Response Period",-1),We=e("th",null,"Publish Results",-1),Xe=e("th",null,"Multiple Responses",-1),et=e("th",null,"Maximum Number of Responses",-1),tt=e("th",null,"Current Number of Responses",-1),st=e("th",null,"Number of Questions",-1),ot=e("h2",{class:"text-2xl font-bold text-primary"},"Questions",-1),nt={class:"tableView table"},lt={colspan:"2"},at=e("th",null,"Question",-1),it=e("th",null,"Total Answers",-1),ut=e("th",null,"Answer Distribution",-1),rt={key:0},ct={class:"answer-bar"},dt={class:"answer-text"},_t={class:"bar-container"},vt={class:"percentage"},mt={class:"answer-text"},pt={key:1},ft={key:0,class:"flex flex-col md:flex-row justify-between items-center w-[80%] mx-auto"},ht=e("span",{class:"mdi mdi-keyboard-backspace text-2xl mr-5"},null,-1),yt=e("span",{class:"mb-2 md:mb-0 inline-block"},"Back to Survey List",-1),bt={key:0,class:"w-full mt-10"},gt={class:"mt-10 text-right"},wt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},xt={class:"bg-white p-6 rounded-md shadow-lg w-full max-w-md"},St=e("h2",{class:"text-xl font-semibold mb-4"},"Update Scheduled Dates",-1),kt={class:"filters mb-10"},Nt={class:"flex items-center"},Dt=e("span",{class:"ml-2"},"Email notification",-1),Tt={class:"flex items-center"},qt=e("span",{class:"ml-2"},"Push notification",-1),Rt={key:0},Ct={class:"date-picker mb-4"},Mt=e("label",{class:"label mb-2",for:"date-from"},"Date From",-1),jt={class:"date-picker mb-4"},At=e("label",{class:"label mb-2",for:"date-to"},"Date To",-1),Vt={class:"col-span-2 mb-2"},$t=e("label",{class:"label mb-2"},"Notification Time",-1),Et={key:1},Pt=e("p",{class:"text-lg text-gray-500 text-center"},"No survey selected. Please choose a survey from the list.",-1),Ut=[Pt],Ft=Ne({__name:"AppSurveyView",props:{id:{type:String,required:!0}},setup(re){var I,K,Y,Z,G;const ce=De(Te.auth),de=N(()=>ce.role===qe),P=h([]),T=h([]),_e=re,U=N({get(){const t=_e.id;return isNaN(Number(t))?t:Number(t)},set(t){return isNaN(Number(t))?t:t.toString()}}),ve=je(),q=te(se.DB,"surveys"),s=h(null),A=async()=>{var o,i;const t=await Ae(q,U.value);s.value=t||null,s.value!==null&&(S.value=s.value.answer_date_from,k.value=s.value.answer_date_to,w.value=s.value.scheduled_notification_datetime??0,y.value=!!((o=s.value)!=null&&o.is_notify_mail),g.value=!!((i=s.value)!=null&&i.is_notify_push))};oe(()=>{A()}),Re(U,()=>{A()});const y=h(!!((I=s.value)!=null&&I.is_notify_mail)),g=h(!!((K=s.value)!=null&&K.is_notify_push)),R=h(!1),S=h(Number((Y=s.value)==null?void 0:Y.answer_date_from)??0),k=h(Number((Z=s.value)==null?void 0:Z.answer_date_to)??0),w=h(((G=s.value)==null?void 0:G.scheduled_notification_datetime)??0),B=N({get(){return new Date(S.value)},set(t){t===null?S.value=0:S.value=t.getTime()}}),F=N({get(){return new Date(k.value)},set(t){t===null?k.value=0:k.value=t.getTime()}}),L=N({get(){return new Date(w.value)},set(t){t===null?w.value=0:w.value=t.getTime(),s.value!==null&&(s.value.scheduled_notification_datetime=t.getTime())}}),me=h(Date.now()),pe=()=>{R.value=!R.value},O=()=>{R.value=!1},fe=async()=>{var o,i,n,u;if(!s.value){console.error("No survey data available.");return}const t=s.value.id;if(!t){console.error("Survey ID is not provided");return}try{if(g.value!==((o=s.value)==null?void 0:o.is_notify_push)||y.value!==((i=s.value)==null?void 0:i.is_notify_mail)){const l=s.value.target_mails,a=s.value.title;g.value,(n=s.value)==null||n.is_notify_push,y.value!==((u=s.value)==null?void 0:u.is_notify_mail)&&(Ve(""),y.value&&w.value&&$e(w.value,l??[],Ee(a),Pe(t,"surveys"),t.toString())),await he(t,y.value,g.value,S.value,k.value,w.value),A()}O()}catch(l){console.error("Error updating survey:",l)}},he=async(t,o,i,n,u,l)=>{if(!t){console.error("Survey ID is not provided");return}try{const c={...(await ue.get(`${q}/?id=${t}`)).data,is_notify_mail:o,is_notify_push:i,answer_date_from:n,answer_date_to:u,scheduled_notification_datetime:l};await ue.put(`${q}/${t}`,c);const d=`/survey-view/${t}`;ve.push(d)}catch(a){console.error("Error updating survey data:",a)}};oe(()=>{ye(),ge()});async function ye(){try{const t=await ne(q);P.value.splice(0,P.value.length,...t)}catch(t){console.error("Failed to load survey data:",t)}}const be=te(se.DB,"responses");async function ge(){const t=await ne(be);T.value=t.map(o=>({id:o.id,survey_id:o.survey_id,responder_id:o.responder_id,responses:o.responses.map(i=>({is_mandatory:i.is_mandatory,is_answered:i.is_answered,max_options:i.max_options,question_type:i.question_type,answer:i.answer??void 0,selected_options:i.selected_options.filter(n=>n!==null),mixed_text:i.mixed_text??void 0}))}))}function z(t){return t===0?s.value?j(s.value.answer_date_from):"N/A":s.value?j(s.value.answer_date_to):"N/A"}function Q(t){return t===0?s.value?j(s.value.result_date_from):"N/A":s.value?j(s.value.result_date_to):"N/A"}function H(t,o){const i=T.value.filter(u=>u.survey_id===t);return i.length?i.flatMap(u=>{const l=u.responses[o];if(!l)return[];const a=[];switch(l.question_type){case"mixed":case"multiple-choice":l.selected_options.length>0&&l.selected_options[0]!==null&&a.push(l.selected_options[0].toString());break;case"text":l.answer&&a.push(l.answer);break}return a}).length:0}function we(t,o){const i=T.value.filter(l=>l.survey_id===t);if(!i.length)return[];const n={};i.forEach(l=>{const a=l.responses[o];if(a)switch(a.question_type){case"multiple-choice":case"mixed":{const x=Array.isArray(a.selected_options)?a.selected_options:[a.selected_options],c=a.selected_options.length-1;x.forEach(d=>{d!==null&&d!==c&&(n[d]=(n[d]||0)+1)});break}case"text":{a.answer&&(n[a.answer]=(n[a.answer]||0)+1);break}}});const u=H(t,o);return Object.keys(n).map(l=>{var c;const a=(c=s.value)==null?void 0:c.questions[o];return{answer:a!=null&&a.question_options?a.question_options[parseInt(l)].text:l,count:n[l],percentage:u>0?n[l]/u*100:0}})}const xe=t=>{if(!s.value)return console.error("Selected survey is null."),"";const o=`Title	${t.title}`,i=`概要	${t.description}`,n=["回答番号","ログインユーザー名","回数"];t.questions.forEach((c,d)=>{n.push(`設問 ${d+1}`)});const u=n.join("	"),l=T.value.filter(c=>c.survey_id===t.id);let a=0;const x=l.sort((c,d)=>(c.id||0)-(d.id||0)).map(c=>{var W;a+=1;let d;((W=s.value)==null?void 0:W.is_multiple_entries)===!1?d=1:d=l.filter(_=>_.responder_id===c.responder_id).findIndex(_=>_.id===c.id)+1;const J=(p,_)=>{var X,ee;const f=(X=s.value)==null?void 0:X.questions[p];return((ee=f==null?void 0:f.question_options)==null?void 0:ee[_].text)??""},ke=p=>{var f,b;const _=(f=s.value)==null?void 0:f.questions[p];return((b=_==null?void 0:_.question_options)==null?void 0:b.length)??0-1};return[a,`(${c.responder_id}) ${$(c.responder_id).name||""}`,d,c.responses.map((p,_)=>{if(p.question_type==="text")return p.answer||"";if(p.question_type==="multiple-choice")return p.selected_options.map(b=>J(_,b)).join(", ");{let f=[];return p.selected_options.map(b=>{b===ke(_)?f.push(`その他 (${p.mixed_text??""})`):f.push(J(_,b))}),f.join(", ")}}).join("	")].join("	")}).join(`
`);return[o,i,u,x].join(`
`)},Se=t=>{const o=xe(t),i=new Blob([o],{type:"text/tab-separated-values;charset=utf-8;"}),n=URL.createObjectURL(i),u=document.createElement("a");u.href=n;const l=`${t.title.replace(/[/\\?%*:|"<>]/g,"-")}.csv`;u.download=l,document.body.appendChild(u),u.click(),document.body.removeChild(u)};return(t,o)=>{const i=Ue("router-link");return m(),v("div",Fe,[s.value?(m(),v("div",Le,[e("div",Oe,[e("h1",ze,r(s.value.title),1)]),e("div",Qe,[He,e("table",Ie,[e("tbody",null,[e("tr",null,[Ke,e("td",Ye,r(s.value.description),1)]),e("tr",null,[Ze,e("td",null,r(D($)(s.value.sender_id).organization)+" "+r(D($)(s.value.sender_id).name),1)]),e("tr",null,[Ge,e("td",null,r(z(0))+" - "+r(z(1)),1)]),e("tr",null,[Je,e("td",null,r(Q(0))+" - "+r(Q(1)),1)]),e("tr",null,[We,e("td",null,r(s.value.is_publish_results?"公開する":"公開しない"),1)]),e("tr",null,[Xe,e("td",null,r(s.value.is_multiple_entries?"許可する":"許可しない"),1)]),e("tr",null,[et,e("td",null,r(s.value.max_number_of_entries??"設定なし"),1)]),e("tr",null,[tt,e("td",null,r(s.value.current_number_of_entries)+" 件",1)]),e("tr",null,[st,e("td",null,r(s.value.questions.length)+" 問",1)])])]),ot,e("table",nt,[e("tbody",null,[(m(!0),v(V,null,le(s.value.questions,(n,u)=>(m(),v(V,{key:u},[e("tr",null,[e("th",lt,"Question "+r(u+1),1)]),e("tr",null,[at,e("td",null,r(n.question_text),1)]),e("tr",null,[it,e("td",null,r(H(s.value.id,u))+" 件",1)]),e("tr",null,[ut,n.question_type==="multiple-choice"||n.question_type==="mixed"?(m(),v("td",rt,[e("ul",null,[(m(!0),v(V,null,le(we(s.value.id,u),(l,a)=>(m(),v("li",{key:a},[e("div",ct,[e("div",dt,r(l.answer),1),e("div",_t,[e("div",{class:"bar",style:Be({width:l.percentage+"%"})},null,4),e("div",vt,r(l.percentage.toFixed(1))+"%",1)]),e("div",mt,r(l.count)+" 件",1)])]))),128))])])):(m(),v("td",pt," 自由入力欄は集計対象外 "))])],64))),128))])])]),de.value?(m(),v("div",ft,[C(i,{to:{path:"/sent_messages",query:{activeTab:"survey"}},class:"button primary-button flex items-center justify-center mb-5"},{default:Ce(()=>[ht,yt]),_:1}),s.value.answer_date_from>me.value?(m(),v("div",bt,[e("div",gt,[e("button",{class:"button primary-button",onClick:Me(pe,["prevent"])}," Edit scheduled dates ")]),R.value?(m(),v("div",wt,[e("div",xt,[St,e("div",kt,[e("label",Nt,[ae(e("input",{type:"checkbox",class:"toggle toggle-lg [--tglbg:#D8D8DB]","onUpdate:modelValue":o[0]||(o[0]=n=>y.value=n)},null,512),[[ie,y.value]]),Dt]),e("label",Tt,[ae(e("input",{type:"checkbox",class:"toggle toggle-lg [--tglbg:#D8D8DB]","onUpdate:modelValue":o[1]||(o[1]=n=>g.value=n)},null,512),[[ie,g.value]]),qt]),y.value||g.value?(m(),v("div",Rt,[e("div",Ct,[Mt,C(D(E),{"auto-apply":"",format:"yyyy/MM/dd","input-class-name":"input","enable-time-picker":!1,modelValue:B.value,"onUpdate:modelValue":o[2]||(o[2]=n=>B.value=n),required:"",class:"custom-datepicker"},null,8,["modelValue"])]),e("div",jt,[At,C(D(E),{"auto-apply":"",format:"yyyy/MM/dd","input-class-name":"input","enable-time-picker":!1,modelValue:F.value,"onUpdate:modelValue":o[3]||(o[3]=n=>F.value=n),required:"",class:"custom-datepicker"},null,8,["modelValue"])]),e("div",Vt,[$t,C(D(E),{"enable-time-picker":"",format:"yyyy/MM/dd HH:mm","input-class-name":"input",modelValue:L.value,"onUpdate:modelValue":o[4]||(o[4]=n=>L.value=n),required:"",class:"custom-input"},null,8,["modelValue"])])])):M("",!0)]),e("div",{class:"flex justify-between mt-6"},[e("button",{class:"button secondary-button",onClick:O},"Close"),e("button",{class:"button primary-button",onClick:fe}," Update ")])])])):M("",!0)])):M("",!0),e("button",{class:"button success-button",onClick:o[5]||(o[5]=n=>Se(s.value))}," Download Result ")])):M("",!0)])):(m(),v("div",Et,Ut))])}}});export{Ft as default};
